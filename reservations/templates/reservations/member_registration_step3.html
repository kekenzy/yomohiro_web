{% extends 'reservations/base.html' %}

{% block title %}会員登録 Step3: 顔写真登録 - 予約システム{% endblock %}

{% block extra_css %}
<style>
    .step-indicator {
        margin-bottom: 2rem;
    }
    .step-item {
        display: inline-block;
        padding: 0.5rem 1rem;
        margin: 0 0.25rem;
        border-radius: 0.5rem;
        background-color: #e9ecef;
        color: #6c757d;
    }
    .step-item.active {
        background-color: #ffc107;
        color: #000;
        font-weight: bold;
    }
    .step-item.completed {
        background-color: #198754;
        color: #fff;
    }
    .photo-preview {
        max-width: 100%;
        max-height: 400px;
        border: 2px solid #dee2e6;
        border-radius: 0.5rem;
        margin: 1rem 0;
    }
    .camera-container {
        margin: 1rem 0;
    }
    #camera-video {
        width: 100%;
        max-width: 400px;
        border: 2px solid #dee2e6;
        border-radius: 0.5rem;
    }
    .photo-options {
        display: flex;
        gap: 1rem;
        margin: 1rem 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h2 class="card-title mb-0">
                    <i class="fas fa-user-plus"></i> 会員登録
                </h2>
            </div>
            <div class="card-body">
                <!-- ステップインジケーター -->
                <div class="step-indicator text-center">
                    {% for i in "1234"|make_list %}
                        <span class="step-item {% if forloop.counter == step %}active{% elif forloop.counter < step %}completed{% endif %}">
                            Step {{ forloop.counter }}
                        </span>
                    {% endfor %}
                </div>

                <h4 class="mb-4">Step3: 顔写真登録</h4>

                {% if form.errors %}
                    <div class="alert alert-danger">
                        <h5 class="alert-heading">
                            <i class="fas fa-exclamation-triangle"></i> エラーが発生しました
                        </h5>
                        <ul class="mb-0">
                            {% for field, errors in form.errors.items %}
                                {% for error in errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}

                <form method="post" id="registration-step3-form" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <!-- 写真プレビュー -->
                    <div id="photo-preview-container" style="display: none;">
                        <img id="photo-preview" class="photo-preview" src="" alt="プレビュー">
                    </div>

                    <!-- カメラ撮影 -->
                    <div id="camera-container" class="camera-container" style="display: none;">
                        <video id="camera-video" autoplay playsinline></video>
                        <div class="mt-2">
                            <button type="button" id="capture-btn" class="btn btn-warning">
                                <i class="fas fa-camera"></i> 撮影
                            </button>
                            <button type="button" id="stop-camera-btn" class="btn btn-outline-secondary">
                                <i class="fas fa-stop"></i> カメラを停止
                            </button>
                        </div>
                        <canvas id="camera-canvas" style="display: none;"></canvas>
                    </div>

                    <div class="photo-options">
                        <button type="button" id="file-select-btn" class="btn btn-outline-primary">
                            <i class="fas fa-folder-open"></i> ファイルから選択
                        </button>
                        <button type="button" id="camera-btn" class="btn btn-outline-primary">
                            <i class="fas fa-camera"></i> カメラで撮影
                        </button>
                    </div>

                    <input type="file" id="photo_upload" name="photo" accept="image/*" style="display: none;">
                    <input type="hidden" id="photo_base64" name="photo_base64">

                    <div class="d-grid gap-2 d-md-flex justify-content-md-between mt-4">
                        <a href="{% url 'reservations:member_registration' %}?step=2" class="btn btn-outline-secondary btn-lg">
                            <i class="fas fa-arrow-left"></i> 戻る
                        </a>
                        <button type="submit" class="btn btn-warning btn-lg" id="submit-btn" disabled>
                            次へ <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let stream = null;
    const photoUpload = document.getElementById('photo_upload');
    const photoBase64 = document.getElementById('photo_base64');
    const photoPreview = document.getElementById('photo-preview');
    const photoPreviewContainer = document.getElementById('photo-preview-container');
    const cameraContainer = document.getElementById('camera-container');
    const cameraVideo = document.getElementById('camera-video');
    const cameraCanvas = document.getElementById('camera-canvas');
    const fileSelectBtn = document.getElementById('file-select-btn');
    const cameraBtn = document.getElementById('camera-btn');
    const captureBtn = document.getElementById('capture-btn');
    const stopCameraBtn = document.getElementById('stop-camera-btn');
    const submitBtn = document.getElementById('submit-btn');

    // ファイル選択ボタン
    fileSelectBtn.addEventListener('click', () => {
        photoUpload.click();
    });

    // ファイル選択時の処理
    photoUpload.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const dataURL = e.target.result;
                photoPreview.src = dataURL;
                photoPreviewContainer.style.display = 'block';
                cameraContainer.style.display = 'none';
                photoBase64.value = dataURL;
                submitBtn.disabled = false;
            };
            reader.readAsDataURL(file);
        }
    });

    // カメラボタン
    cameraBtn.addEventListener('click', async () => {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'user' } 
            });
            cameraVideo.srcObject = stream;
            cameraContainer.style.display = 'block';
            photoPreviewContainer.style.display = 'none';
            photoUpload.value = '';
        } catch (error) {
            alert('カメラへのアクセスが拒否されました。');
            console.error('Camera error:', error);
        }
    });

    // 撮影ボタン
    captureBtn.addEventListener('click', () => {
        const context = cameraCanvas.getContext('2d');
        cameraCanvas.width = cameraVideo.videoWidth;
        cameraCanvas.height = cameraVideo.videoHeight;
        context.drawImage(cameraVideo, 0, 0);
        const dataURL = cameraCanvas.toDataURL('image/jpeg');
        photoPreview.src = dataURL;
        photoPreviewContainer.style.display = 'block';
        photoBase64.value = dataURL;
        submitBtn.disabled = false;
        stopCamera();
    });

    // カメラ停止ボタン
    stopCameraBtn.addEventListener('click', () => {
        stopCamera();
    });

    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
            cameraVideo.srcObject = null;
            cameraContainer.style.display = 'none';
        }
    }

    // ページを離れる前にカメラを停止
    window.addEventListener('beforeunload', () => {
        stopCamera();
    });
</script>
{% endblock %}

