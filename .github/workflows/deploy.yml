name: Deploy to AWS Lightsail

on:
  push:
    branches:
      - main  # mainブランチへのプッシュでデプロイ
      - master  # または master ブランチ
  workflow_dispatch:  # 手動実行も可能

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run migrations check
      run: |
        python manage.py makemigrations --check --dry-run
    
    - name: Run tests
      run: |
        python manage.py test

  deploy:
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy to Lightsail
      env:
        LIGHTSAIL_HOST: ${{ secrets.LIGHTSAIL_HOST }}
        LIGHTSAIL_USER: ${{ secrets.LIGHTSAIL_USER }}
        LIGHTSAIL_SSH_KEY: ${{ secrets.LIGHTSAIL_SSH_KEY }}
      run: |
        # SSH秘密鍵をセットアップ
        mkdir -p ~/.ssh
        echo "$LIGHTSAIL_SSH_KEY" > ~/.ssh/lightsail_key
        chmod 600 ~/.ssh/lightsail_key
        
        # SSH設定を作成
        cat > ~/.ssh/config << EOF
        Host lightsail
          HostName $LIGHTSAIL_HOST
          User $LIGHTSAIL_USER
          IdentityFile ~/.ssh/lightsail_key
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null
        EOF
        
        # SSH接続テスト
        echo "Testing SSH connection..."
        echo "cat ~/.ssh/lightsail_key""
        echo lightsail
        ssh -o ConnectTimeout=10 lightsail "echo 'SSH connection successful'"
        
        # デプロイスクリプトを実行
        ssh lightsail << 'ENDSSH'
          cd /home/ubuntu/yomohiro_web
          git pull origin main
          source venv/bin/activate
          pip install -r requirements.txt
          python manage.py migrate
          python manage.py collectstatic --noinput
          sudo systemctl restart gunicorn
          sudo systemctl restart nginx
        ENDSSH
    
    - name: Deployment Status
      if: success()
      run: echo "✅ Deployment successful!"
    
    - name: Deployment Failed
      if: failure()
      run: echo "❌ Deployment failed!"

